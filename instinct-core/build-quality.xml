<?xml version="1.0" encoding="UTF-8"?>
<project name="instinct-checkstyle" default="checkstyle">

    <import file="build-setup.xml"/>

    <target name="_checkstyle">
        <macro_checkstyle code.type="main"/>
        <macro_checkstyle code.type="test"/>
    </target>

    <target name="checkstyle">
        <taskdef resource="checkstyletask.properties" classpath="${lib.dir}/checkstyle/checkstyle-all-4.2.jar"/>
        <checkstyle config="${etc.dir}/checkstyle/checkstyle-main.xml">
            <fileset dir="${main.src.dir}"/>
        </checkstyle>
    </target>

    <macrodef name="macro_checkstyle">
        <attribute name="code.type"/>
        <sequential>
            <macro_run_checkstyle code.type="@{code.type}"/>
            <macro_check_checkstyle code.type="@{code.type}"/>
        </sequential>
    </macrodef>

    <macrodef name="macro_run_checkstyle">
        <attribute name="code.type"/>
        <sequential>
            <mkdir dir="${checkstyle.results.dir}"/>
            <taskdef resource="checkstyletask.properties" classpathref="${lib.dir}/checkstyle/checkstyle-all-4.2.jar"/>
            <checkstyle config="${etc.dir}/checkstyle/checkstyle-@{code.type}.xml"
                        failOnViolation="false" failureProperty="checkstyle.@{code.type}.failed">
                <formatter/>
                <formatter type="xml" tofile="${reports.checkstyle.dir}/checkstyle-@{code.type}.xml"/>
                <fileset refid="src.@{code.type}.java.fileset"/>
            </checkstyle>
            <style in="${reports.checkstyle.dir}/checkstyle-@{code.type}.xml" out="${reports.checkstyle.dir}/checkstyle-@{code.type}.html"
                   style="${etc.dir}/checkstyle/checkstyle-noframes-sorted.xsl"/>
        </sequential>
    </macrodef>

    <macrodef name="macro_check_checkstyle">
        <attribute name="code.type"/>
        <sequential>
            <fail if="checkstyle.@{code.type}.failed" message="Checkstyle failure [@{code.type}]."/>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_report">
        <sequential>
            <mkdir dir="${coverage.dir}"/>
            <cobertura-report destdir="${coverage.dir}" datafile="${coverage.dir}/coverage.ser">
                <fileset dir="${main.src.dir}" includes="**/*.java"/>
            </cobertura-report>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_check">
        <attribute name="branch.limit"/>
        <attribute name="line.limit"/>
        <sequential>
            <cobertura-check totalbranchrate="@{branch.limit}" totallinerate="@{line.limit}" failureproperty="coverage.failed" haltonfailure="true"
                    datafile="${coverage.dir}/coverage.ser"/>
        </sequential>
    </macrodef>
</project>